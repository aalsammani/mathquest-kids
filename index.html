<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathQuest Kids - Learn Math K-3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }

        /* Floating background shapes */
        .bg-shapes {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .bg-shape {
            position: absolute;
            opacity: 0.1;
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(180deg); }
        }

        .app-container {
            background: white;
            border-radius: 30px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 900px;
            min-height: 600px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            background-size: 300% 300%;
            animation: gradient 6s ease infinite;
            padding: 25px;
            text-align: center;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 5px;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.4);
            animation: titleBounce 2s ease-in-out infinite;
        }

        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .author-name {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 1.1em;
            font-weight: bold;
        }

        .grade-selector {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
        }

        .grade-selector h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .grade-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            padding: 18px 35px;
            margin: 12px;
            border-radius: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
            transform: scale(1);
        }

        .grade-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.5);
        }

        .grade-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.5);
            animation: wiggle 0.5s ease;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .topic-selector {
            padding: 30px;
            display: none;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e8ff 100%);
        }

        .topic-selector h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8em;
            text-align: center;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .topic-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .topic-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            transition: left 0.5s;
        }

        .topic-card:hover::before {
            left: 100%;
        }

        .topic-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-color: #ff6b6b;
        }

        .topic-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .topic-card h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.3em;
        }

        .topic-card p {
            color: #666;
            font-size: 0.95em;
        }

        .game-area {
            padding: 35px;
            display: none;
            text-align: center;
            min-height: 450px;
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
        }

        .progress-bar {
            background: #e0e0e0;
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.5s ease;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(78, 205, 196, 0.5);
        }

        .question-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 45px 30px;
            border-radius: 25px;
            margin: 25px 0;
            font-size: 2.2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visual-area {
            margin: 30px 0;
            min-height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
        }

        .visual-item {
            width: 50px;
            height: 50px;
            background: #ff6b6b;
            border-radius: 50%;
            display: inline-block;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            animation: itemPop 0.5s ease backwards;
        }

        @keyframes itemPop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .visual-item.apple { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }
        .visual-item.orange { background: linear-gradient(135deg, #ffa726, #ff9800); }
        .visual-item.green { background: linear-gradient(135deg, #66bb6a, #4caf50); }
        .visual-item.blue { background: linear-gradient(135deg, #42a5f5, #2196f3); }
        .visual-item.purple { background: linear-gradient(135deg, #ab47bc, #9c27b0); }

        /* Multiplication groups */
        .mult-group {
            display: inline-block;
            margin: 15px;
            animation: groupPop 0.6s ease backwards;
        }

        @keyframes groupPop {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .mult-group-circle {
            position: relative;
            border: 4px dashed #667eea;
            border-radius: 50%;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            min-height: 120px;
        }

        .mult-group-circle .visual-item {
            width: 35px;
            height: 35px;
        }

        .mult-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        .answer-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 20px;
            font-size: 1.6em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.4);
            position: relative;
            overflow: hidden;
        }

        .answer-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .answer-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .answer-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(78, 205, 196, 0.5);
        }

        .answer-btn.correct {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            animation: correctBounce 0.6s ease;
        }

        .answer-btn.incorrect {
            background: linear-gradient(45deg, #ef5350, #f44336);
            animation: shake 0.5s ease;
        }

        @keyframes correctBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1); }
            40% { transform: translateY(-15px) scale(1.1); }
            60% { transform: translateY(-7px) scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }

        .feedback {
            margin-top: 25px;
            padding: 25px;
            border-radius: 20px;
            font-size: 1.3em;
            font-weight: bold;
            display: none;
            animation: feedbackSlide 0.5s ease;
        }

        @keyframes feedbackSlide {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .feedback.correct {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
            color: #2e7d32;
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, #ffcdd2, #ef9a9a);
            color: #c62828;
            box-shadow: 0 10px 25px rgba(244, 67, 54, 0.3);
        }

        .controls {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .voice-controls {
            margin-bottom: 25px;
            text-align: center;
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 20px;
        }

        .voice-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .voice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .voice-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .control-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.5);
        }

        .score-display {
            background: linear-gradient(135deg, #ffd54f, #ffb300);
            color: #bf360c;
            padding: 18px 30px;
            border-radius: 30px;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 25px;
            display: inline-block;
            box-shadow: 0 10px 25px rgba(255, 213, 79, 0.4);
            animation: scoreFloat 3s ease-in-out infinite;
        }

        @keyframes scoreFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            animation: fall 3s linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        .hidden { display: none; }
        .show { display: block; }

        @media (max-width: 600px) {
            .app-container {
                width: 95%;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .question-display {
                font-size: 1.6em;
                padding: 30px 20px;
            }
            
            .answer-btn {
                padding: 18px;
                font-size: 1.3em;
            }

            .mult-group-circle {
                min-width: 100px;
                min-height: 100px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-shapes">
        <div class="bg-shape" style="font-size: 100px; top: 10%; left: 10%;">⭐</div>
        <div class="bg-shape" style="font-size: 80px; top: 70%; left: 80%; animation-delay: -5s;">🌟</div>
        <div class="bg-shape" style="font-size: 90px; top: 50%; left: 5%; animation-delay: -10s;">✨</div>
        <div class="bg-shape" style="font-size: 70px; top: 20%; left: 85%; animation-delay: -15s;">💫</div>
    </div>

    <div class="app-container">
        <header class="header">
            <h1>🌟 MathQuest Kids 🌟</h1>
            <p class="author-name">by Abdallah Alsammani</p>
            <p class="subtitle">Fun Math Learning for Grades K-3</p>
        </header>

        <div id="gradeSelection" class="grade-selector">
            <h2>Choose Your Grade Level:</h2>
            <button class="grade-btn" data-grade="k">🎈 Kindergarten</button>
            <button class="grade-btn" data-grade="1">🚀 Grade 1</button>
            <button class="grade-btn" data-grade="2">⭐ Grade 2</button>
            <button class="grade-btn" data-grade="3">🏆 Grade 3</button>
        </div>

        <div id="topicSelection" class="topic-selector">
            <h2>Choose a Math Adventure:</h2>
            <div class="topic-grid" id="topicGrid"></div>
        </div>

        <div id="gameArea" class="game-area">
            <div class="score-display" id="scoreDisplay">Score: 0 | Streak: 0</div>
            <div class="voice-controls">
                <button class="voice-btn" id="voiceToggle">🔊 Voice On</button>
                <button class="voice-btn" id="repeatQuestion">🔄 Repeat Question</button>
                <button class="voice-btn" id="voiceSpeed">🐌 Normal Speed</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="question-display" id="questionDisplay"></div>
            <div class="visual-area" id="visualArea"></div>
            <div class="answer-options" id="answerOptions"></div>
            <div class="feedback" id="feedback"></div>
            <div class="controls">
                <button class="control-btn" id="nextBtn" style="display: none;">Next Question →</button>
                <button class="control-btn" id="backBtn">← Back to Topics</button>
                <button class="control-btn" id="hintBtn">💡 Hint</button>
            </div>
        </div>
    </div>

    <div class="celebration" id="celebration"></div>

    <script>
        class MathQuestApp {
            constructor() {
                this.currentGrade = null;
                this.currentTopic = null;
                this.currentQuestion = null;
                this.score = 0;
                this.streak = 0;
                this.questionCount = 0;
                this.totalQuestions = 10;
                this.questionsCorrect = 0;
                
                this.voiceEnabled = true;
                this.speechSynthesis = window.speechSynthesis;
                this.currentVoice = null;
                this.speechRate = 0.8;
                this.availableVoices = [];
                
                this.initializeVoices();
                
                this.topics = {
                    k: [
                        { id: 'counting', name: 'Counting 1-10', icon: '🔢', description: 'Count objects and numbers' },
                        { id: 'shapes', name: 'Shapes', icon: '⚪', description: 'Learn basic shapes' },
                        { id: 'patterns', name: 'Patterns', icon: '🔴🔵', description: 'Simple patterns' },
                        { id: 'size', name: 'Big & Small', icon: '📏', description: 'Compare sizes' }
                    ],
                    1: [
                        { id: 'addition10', name: 'Addition to 10', icon: '➕', description: 'Add numbers up to 10' },
                        { id: 'subtraction10', name: 'Subtraction to 10', icon: '➖', description: 'Subtract numbers up to 10' },
                        { id: 'counting20', name: 'Counting to 20', icon: '🔢', description: 'Count higher numbers' },
                        { id: 'place_value', name: 'Tens & Ones', icon: '🔟', description: 'Understanding place value' }
                    ],
                    2: [
                        { id: 'addition100', name: 'Addition to 100', icon: '➕', description: 'Add bigger numbers' },
                        { id: 'subtraction100', name: 'Subtraction to 100', icon: '➖', description: 'Subtract bigger numbers' },
                        { id: 'skip_counting', name: 'Skip Counting', icon: '⏭️', description: 'Count by 2s, 5s, 10s' },
                        { id: 'time', name: 'Time', icon: '🕐', description: 'Reading clocks' }
                    ],
                    3: [
                        { id: 'multiplication', name: 'Multiplication', icon: '✖️', description: 'Times tables' },
                        { id: 'division', name: 'Division', icon: '➗', description: 'Sharing equally' },
                        { id: 'fractions', name: 'Fractions', icon: '🍕', description: 'Parts of a whole' },
                        { id: 'measurement', name: 'Measurement', icon: '📐', description: 'Length and weight' }
                    ]
                };
                
                this.initializeApp();
            }

            initializeApp() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.querySelectorAll('.grade-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectGrade(e.target.dataset.grade);
                    });
                });

                document.getElementById('backBtn').addEventListener('click', () => {
                    this.showTopicSelection();
                });

                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });

                document.getElementById('hintBtn').addEventListener('click', () => {
                    this.showHint();
                });

                document.getElementById('voiceToggle').addEventListener('click', () => {
                    this.toggleVoice();
                });

                document.getElementById('repeatQuestion').addEventListener('click', () => {
                    this.repeatCurrentQuestion();
                });

                document.getElementById('voiceSpeed').addEventListener('click', () => {
                    this.cycleVoiceSpeed();
                });
            }

            initializeVoices() {
                const loadVoices = () => {
                    this.availableVoices = this.speechSynthesis.getVoices();
                    
                    const preferredVoices = [
                        'Google UK English Female',
                        'Microsoft Zira Desktop',
                        'Alex',
                        'Samantha',
                        'Google US English'
                    ];
                    
                    for (let preferred of preferredVoices) {
                        const voice = this.availableVoices.find(v => 
                            v.name.includes(preferred) || v.name.toLowerCase().includes('female')
                        );
                        if (voice) {
                            this.currentVoice = voice;
                            break;
                        }
                    }
                    
                    if (!this.currentVoice) {
                        this.currentVoice = this.availableVoices.find(v => 
                            v.lang.startsWith('en')
                        ) || this.availableVoices[0];
                    }
                };

                loadVoices();
                this.speechSynthesis.addEventListener('voiceschanged', loadVoices);
            }

            speak(text, options = {}) {
                if (!this.voiceEnabled || !this.speechSynthesis) return;
                
                this.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = this.currentVoice;
                utterance.rate = options.rate || this.speechRate;
                utterance.pitch = options.pitch || 1.1;
                utterance.volume = options.volume || 0.8;
                
                if (options.showSpeaking) {
                    this.showSpeakingIndicator();
                    utterance.addEventListener('end', () => {
                        this.hideSpeakingIndicator();
                    });
                }
                
                this.speechSynthesis.speak(utterance);
                return utterance;
            }

            toggleVoice() {
                this.voiceEnabled = !this.voiceEnabled;
                const btn = document.getElementById('voiceToggle');
                
                if (this.voiceEnabled) {
                    btn.textContent = '🔊 Voice On';
                    btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                    this.speak("Voice is now on! I'll read questions and give you feedback.", { showSpeaking: true });
                } else {
                    btn.textContent = '🔇 Voice Off';
                    btn.style.background = 'linear-gradient(45deg, #666, #888)';
                    this.speechSynthesis.cancel();
                }
            }

            repeatCurrentQuestion() {
                if (this.currentQuestion) {
                    this.speak(this.currentQuestion.question, { showSpeaking: true });
                }
            }

            cycleVoiceSpeed() {
                const speeds = [
                    { rate: 0.6, label: '🐌 Slow', description: 'Speaking slowly' },
                    { rate: 0.8, label: '🚶 Normal', description: 'Speaking at normal speed' },
                    { rate: 1.0, label: '🏃 Fast', description: 'Speaking quickly' }
                ];
                
                const currentIndex = speeds.findIndex(s => s.rate === this.speechRate);
                const nextIndex = (currentIndex + 1) % speeds.length;
                const nextSpeed = speeds[nextIndex];
                
                this.speechRate = nextSpeed.rate;
                
                const btn = document.getElementById('voiceSpeed');
                btn.textContent = nextSpeed.label;
                
                this.speak(nextSpeed.description, { rate: this.speechRate, showSpeaking: true });
            }

            showSpeakingIndicator() {
                const indicator = document.createElement('span');
                indicator.id = 'speakingIndicator';
                indicator.innerHTML = ' <span style="animation: soundWave 1s ease-in-out infinite;">🔊</span>';
                indicator.style.color = '#4ecdc4';
                indicator.style.fontWeight = 'bold';
                
                const questionDisplay = document.getElementById('questionDisplay');
                questionDisplay.appendChild(indicator);
            }

            hideSpeakingIndicator() {
                const indicator = document.getElementById('speakingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            selectGrade(grade) {
                this.currentGrade = grade;
                
                document.querySelectorAll('.grade-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-grade="${grade}"]`).classList.add('active');
                
                this.showTopicSelection();
            }

            showTopicSelection() {
                document.getElementById('gradeSelection').style.display = 'none';
                document.getElementById('gameArea').style.display = 'none';
                document.getElementById('topicSelection').style.display = 'block';
                
                this.populateTopics();
            }

            populateTopics() {
                const topicGrid = document.getElementById('topicGrid');
                topicGrid.innerHTML = '';
                
                this.topics[this.currentGrade].forEach((topic, index) => {
                    const topicCard = document.createElement('div');
                    topicCard.className = 'topic-card';
                    topicCard.style.animationDelay = `${index * 0.1}s`;
                    topicCard.innerHTML = `
                        <div class="topic-icon">${topic.icon}</div>
                        <h3>${topic.name}</h3>
                        <p>${topic.description}</p>
                    `;
                    topicCard.addEventListener('click', () => {
                        this.selectTopic(topic.id);
                    });
                    topicGrid.appendChild(topicCard);
                });
            }

            selectTopic(topicId) {
                this.currentTopic = topicId;
                this.score = 0;
                this.streak = 0;
                this.questionCount = 0;
                this.questionsCorrect = 0;
                
                document.getElementById('topicSelection').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                
                this.startGame();
            }

            startGame() {
                this.updateScore();
                
                const welcomeMessages = [
                    `Welcome to ${this.getTopicName()}! Let's practice some math together!`,
                    `Great choice! Time to have fun with ${this.getTopicName()}!`,
                    `Ready to learn ${this.getTopicName()}? Let's go!`,
                    `Let's explore ${this.getTopicName()} together! You've got this!`
                ];
                
                const welcomeMsg = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                
                setTimeout(() => {
                    this.speak(welcomeMsg, { showSpeaking: true });
                }, 800);
                
                this.nextQuestion();
            }

            getTopicName() {
                const topicNames = {
                    counting: 'counting',
                    shapes: 'shapes',
                    patterns: 'patterns',
                    size: 'size comparison',
                    addition10: 'addition',
                    subtraction10: 'subtraction',
                    counting20: 'counting to twenty',
                    place_value: 'place value',
                    addition100: 'addition',
                    subtraction100: 'subtraction',
                    skip_counting: 'skip counting',
                    time: 'telling time',
                    multiplication: 'multiplication',
                    division: 'division',
                    fractions: 'fractions',
                    measurement: 'measurement'
                };
                
                return topicNames[this.currentTopic] || 'math';
            }

            nextQuestion() {
                if (this.questionCount >= this.totalQuestions) {
                    this.endGame();
                    return;
                }

                this.questionCount++;
                this.clearFeedback();
                document.getElementById('nextBtn').style.display = 'none';
                
                this.currentQuestion = this.generateQuestion();
                this.displayQuestion();
                this.updateProgress();
            }

            generateQuestion() {
                const generators = {
                    counting: () => this.generateCounting(),
                    shapes: () => this.generateShapes(),
                    patterns: () => this.generatePatterns(),
                    size: () => this.generateSize(),
                    addition10: () => this.generateAddition(10),
                    subtraction10: () => this.generateSubtraction(10),
                    counting20: () => this.generateCountingHigher(),
                    place_value: () => this.generatePlaceValue(),
                    addition100: () => this.generateAddition(100),
                    subtraction100: () => this.generateSubtraction(100),
                    skip_counting: () => this.generateSkipCounting(),
                    time: () => this.generateTime(),
                    multiplication: () => this.generateMultiplication(),
                    division: () => this.generateDivision(),
                    fractions: () => this.generateFractions(),
                    measurement: () => this.generateMeasurement()
                };

                return generators[this.currentTopic]();
            }

            generateCounting() {
                const max = Math.floor(Math.random() * 5) + 3;
                const colors = ['apple', 'orange', 'green', 'blue', 'purple'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = Math.floor(Math.random() * 10) + 1;
                    if (wrong !== max && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }

                return {
                    question: "How many objects do you see?",
                    visual: { type: 'objects', count: max, color: color },
                    correct: max,
                    options: [max, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Try counting each object: 1, 2, 3...`
                };
            }

            generateShapes() {
                const shapes = [
                    { name: 'circle', symbol: '⚪', sides: 'curved' },
                    { name: 'square', symbol: '⬜', sides: '4 equal' },
                    { name: 'triangle', symbol: '🔺', sides: '3' },
                    { name: 'rectangle', symbol: '▭', sides: '4' }
                ];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                const wrongShapes = shapes.filter(s => s !== shape).slice(0, 3);

                return {
                    question: `Which shape is this? ${shape.symbol}`,
                    visual: { type: 'shape', shape: shape.symbol },
                    correct: shape.name,
                    options: [shape.name, ...wrongShapes.map(s => s.name)].sort(() => Math.random() - 0.5),
                    hint: `This shape has ${shape.sides} sides.`
                };
            }

            generatePatterns() {
                const patterns = [
                    { pattern: ['🔴', '🔵'], next: '🔴' },
                    { pattern: ['⭐', '⭐', '❤️'], next: '⭐' },
                    { pattern: ['🟡', '🟢', '🟡'], next: '🟢' }
                ];
                const selected = patterns[Math.floor(Math.random() * patterns.length)];
                
                return {
                    question: "What comes next in the pattern?",
                    visual: { type: 'pattern', pattern: [...selected.pattern, ...selected.pattern, '?'] },
                    correct: selected.next,
                    options: ['🔴', '🔵', '⭐', '❤️', '🟡', '🟢'].slice(0, 4),
                    hint: "Look for the repeating pattern!"
                };
            }

            generateSize() {
                const sizes = ['big', 'small'];
                const correct = sizes[Math.floor(Math.random() * 2)];
                
                return {
                    question: "Which circle is bigger?",
                    visual: { type: 'size', big: true },
                    correct: correct,
                    options: ['big', 'small'],
                    hint: "Compare the sizes carefully!"
                };
            }

            generateAddition(max) {
                const a = Math.floor(Math.random() * (max/2)) + 1;
                const b = Math.floor(Math.random() * (max - a)) + 1;
                const sum = a + b;
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = sum + Math.floor(Math.random() * 6) - 3;
                    if (wrong > 0 && wrong !== sum && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }

                return {
                    question: `${a} + ${b} = ?`,
                    visual: { type: 'addition', a: a, b: b },
                    correct: sum,
                    options: [sum, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Count all the objects together!`
                };
            }

            generateSubtraction(max) {
                const start = Math.floor(Math.random() * max/2) + 3;
                const subtract = Math.floor(Math.random() * (start - 1)) + 1;
                const result = start - subtract;
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = result + Math.floor(Math.random() * 6) - 3;
                    if (wrong >= 0 && wrong !== result && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }

                return {
                    question: `${start} - ${subtract} = ?`,
                    visual: { type: 'subtraction', start: start, subtract: subtract },
                    correct: result,
                    options: [result, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Take away ${subtract} objects from ${start}.`
                };
            }

            generateCountingHigher() {
                const start = Math.floor(Math.random() * 10) + 10;
                const count = Math.floor(Math.random() * 5) + 3;
                
                return {
                    question: `Count from ${start}. What comes after ${start + count - 1}?`,
                    visual: null,
                    correct: start + count,
                    options: [start + count, start + count + 1, start + count - 1, start + count + 2],
                    hint: `Keep counting: ${start}, ${start + 1}, ${start + 2}...`
                };
            }

            generatePlaceValue() {
                const tens = Math.floor(Math.random() * 3) + 1;
                const ones = Math.floor(Math.random() * 9) + 1;
                const number = tens * 10 + ones;
                
                return {
                    question: `How many ones are in ${number}?`,
                    visual: { type: 'place_value', number: number },
                    correct: ones,
                    options: [ones, tens, number, ones + tens].sort(() => Math.random() - 0.5),
                    hint: `Look at the ones place (the right digit).`
                };
            }

            generateSkipCounting() {
                const skip = [2, 5, 10][Math.floor(Math.random() * 3)];
                const start = skip * 2;
                const sequence = [start, start + skip, start + skip * 2];
                
                return {
                    question: `Skip counting by ${skip}s: ${sequence.join(', ')}, ?`,
                    visual: null,
                    correct: start + skip * 3,
                    options: [start + skip * 3, start + skip * 3 + 1, start + skip * 3 - 1, start + skip * 4],
                    hint: `Add ${skip} to the last number.`
                };
            }

            generateTime() {
                const hour = Math.floor(Math.random() * 12) + 1;
                const minute = [0, 30][Math.floor(Math.random() * 2)];
                const timeStr = minute === 0 ? `${hour}:00` : `${hour}:30`;
                
                return {
                    question: `What time does this show?`,
                    visual: { type: 'clock', hour: hour, minute: minute },
                    correct: timeStr,
                    options: [timeStr, `${hour + 1}:00`, `${hour}:15`, `${hour}:45`],
                    hint: `Look at where the hour and minute hands point.`
                };
            }

            generateMultiplication() {
                const a = Math.floor(Math.random() * 4) + 2;
                const b = Math.floor(Math.random() * 4) + 2;
                const product = a * b;
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = product + Math.floor(Math.random() * 8) - 4;
                    if (wrong > 0 && wrong !== product && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }
                
                return {
                    question: `${a} × ${b} = ?`,
                    visual: { type: 'multiplication', a: a, b: b },
                    correct: product,
                    options: [product, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Think of it as ${a} groups of ${b}.`
                };
            }

            generateDivision() {
                const divisor = Math.floor(Math.random() * 4) + 2;
                const quotient = Math.floor(Math.random() * 5) + 2;
                const dividend = divisor * quotient;
                
                return {
                    question: `${dividend} ÷ ${divisor} = ?`,
                    visual: { type: 'division', total: dividend, groups: divisor },
                    correct: quotient,
                    options: [quotient, quotient + 1, quotient - 1, divisor].sort(() => Math.random() - 0.5),
                    hint: `How many groups of ${divisor} make ${dividend}?`
                };
            }

            generateFractions() {
                const denominators = [2, 3, 4];
                const denominator = denominators[Math.floor(Math.random() * denominators.length)];
                const numerator = Math.floor(Math.random() * denominator) + 1;
                
                return {
                    question: `What fraction is shaded?`,
                    visual: { type: 'fraction', numerator: numerator, denominator: denominator },
                    correct: `${numerator}/${denominator}`,
                    options: [`${numerator}/${denominator}`, `${denominator}/${numerator}`, `${numerator + 1}/${denominator}`, `${numerator}/${denominator + 1}`],
                    hint: `Count the shaded parts out of total parts.`
                };
            }

            generateMeasurement() {
                const units = [
                    { item: 'pencil', length: 6, unit: 'inches' },
                    { item: 'book', length: 9, unit: 'inches' },
                    { item: 'table', length: 3, unit: 'feet' }
                ];
                const selected = units[Math.floor(Math.random() * units.length)];
                
                return {
                    question: `How long is the ${selected.item}?`,
                    visual: { type: 'measurement', item: selected.item, length: selected.length },
                    correct: `${selected.length} ${selected.unit}`,
                    options: [`${selected.length} ${selected.unit}`, `${selected.length + 1} ${selected.unit}`, `${selected.length - 1} ${selected.unit}`, `${selected.length} cm`],
                    hint: `Use the ruler to measure carefully.`
                };
            }

            displayQuestion() {
                document.getElementById('questionDisplay').textContent = this.currentQuestion.question;
                this.displayVisual();
                this.displayAnswerOptions();
                
                setTimeout(() => {
                    this.speak(this.currentQuestion.question, { showSpeaking: true });
                }, 500);
            }

            displayVisual() {
                const visualArea = document.getElementById('visualArea');
                visualArea.innerHTML = '';
                
                if (!this.currentQuestion.visual) return;
                
                const visual = this.currentQuestion.visual;
                
                switch (visual.type) {
                    case 'objects':
                        for (let i = 0; i < visual.count; i++) {
                            const item = document.createElement('div');
                            item.className = `visual-item ${visual.color}`;
                            item.style.animationDelay = `${i * 0.1}s`;
                            visualArea.appendChild(item);
                        }
                        break;
                        
                    case 'shape':
                        const shapeDiv = document.createElement('div');
                        shapeDiv.style.fontSize = '5em';
                        shapeDiv.textContent = visual.shape;
                        visualArea.appendChild(shapeDiv);
                        break;
                        
                    case 'pattern':
                        visual.pattern.forEach((item, idx) => {
                            const patternItem = document.createElement('span');
                            patternItem.style.fontSize = '2.5em';
                            patternItem.style.margin = '0 12px';
                            patternItem.style.display = 'inline-block';
                            patternItem.style.animation = `itemPop 0.5s ease backwards ${idx * 0.1}s`;
                            patternItem.textContent = item;
                            visualArea.appendChild(patternItem);
                        });
                        break;
                        
                    case 'size':
                        const bigCircle = document.createElement('div');
                        bigCircle.style.width = '100px';
                        bigCircle.style.height = '100px';
                        bigCircle.style.borderRadius = '50%';
                        bigCircle.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                        bigCircle.style.margin = '15px';
                        bigCircle.style.display = 'inline-block';
                        bigCircle.style.boxShadow = '0 8px 20px rgba(78, 205, 196, 0.4)';
                        bigCircle.style.animation = 'itemPop 0.5s ease';
                        
                        const smallCircle = document.createElement('div');
                        smallCircle.style.width = '50px';
                        smallCircle.style.height = '50px';
                        smallCircle.style.borderRadius = '50%';
                        smallCircle.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
                        smallCircle.style.margin = '15px';
                        smallCircle.style.display = 'inline-block';
                        smallCircle.style.boxShadow = '0 8px 20px rgba(255, 107, 107, 0.4)';
                        smallCircle.style.animation = 'itemPop 0.5s ease 0.2s backwards';
                        
                        visualArea.appendChild(bigCircle);
                        visualArea.appendChild(smallCircle);
                        break;
                        
                    case 'addition':
                        for (let i = 0; i < visual.a; i++) {
                            const item = document.createElement('div');
                            item.className = 'visual-item blue';
                            item.style.animationDelay = `${i * 0.08}s`;
                            visualArea.appendChild(item);
                        }
                        
                        const plusSign = document.createElement('span');
                        plusSign.style.fontSize = '3em';
                        plusSign.style.margin = '0 25px';
                        plusSign.style.fontWeight = 'bold';
                        plusSign.style.color = '#667eea';
                        plusSign.textContent = '+';
                        visualArea.appendChild(plusSign);
                        
                        for (let i = 0; i < visual.b; i++) {
                            const item = document.createElement('div');
                            item.className = 'visual-item green';
                            item.style.animationDelay = `${(visual.a + i) * 0.08}s`;
                            visualArea.appendChild(item);
                        }
                        break;
                        
                    case 'subtraction':
                        for (let i = 0; i < visual.start; i++) {
                            const item = document.createElement('div');
                            item.className = 'visual-item apple';
                            item.style.animationDelay = `${i * 0.08}s`;
                            if (i >= visual.start - visual.subtract) {
                                item.style.opacity = '0.25';
                                item.style.position = 'relative';
                                item.style.overflow = 'hidden';
                                const line = document.createElement('div');
                                line.style.position = 'absolute';
                                line.style.top = '50%';
                                line.style.left = '0';
                                line.style.width = '100%';
                                line.style.height = '3px';
                                line.style.background = '#333';
                                line.style.transform = 'translateY(-50%) rotate(-45deg)';
                                item.appendChild(line);
                            }
                            visualArea.appendChild(item);
                        }
                        break;
                        
                    case 'place_value':
                        const pvContainer = document.createElement('div');
                        pvContainer.style.display = 'flex';
                        pvContainer.style.gap = '30px';
                        pvContainer.style.justifyContent = 'center';
                        pvContainer.style.fontSize = '1.3em';
                        
                        const tensDiv = document.createElement('div');
                        tensDiv.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        tensDiv.style.color = 'white';
                        tensDiv.style.padding = '20px 30px';
                        tensDiv.style.borderRadius = '15px';
                        tensDiv.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.3)';
                        tensDiv.innerHTML = `<strong>Tens:</strong> ${Math.floor(visual.number / 10)}`;
                        
                        const onesDiv = document.createElement('div');
                        onesDiv.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                        onesDiv.style.color = 'white';
                        onesDiv.style.padding = '20px 30px';
                        onesDiv.style.borderRadius = '15px';
                        onesDiv.style.boxShadow = '0 8px 20px rgba(78, 205, 196, 0.3)';
                        onesDiv.innerHTML = `<strong>Ones:</strong> ${visual.number % 10}`;
                        
                        pvContainer.appendChild(tensDiv);
                        pvContainer.appendChild(onesDiv);
                        visualArea.appendChild(pvContainer);
                        break;
                        
                    case 'clock':
                        const clockDiv = document.createElement('div');
                        clockDiv.style.fontSize = '6em';
                        clockDiv.textContent = '🕐';
                        clockDiv.style.animation = 'itemPop 0.5s ease';
                        
                        const timeLabel = document.createElement('div');
                        timeLabel.style.fontSize = '1.3em';
                        timeLabel.style.marginTop = '15px';
                        timeLabel.style.fontWeight = 'bold';
                        timeLabel.style.color = '#667eea';
                        timeLabel.textContent = visual.minute === 0 ? 'On the hour' : 'Half past';
                        
                        visualArea.appendChild(clockDiv);
                        visualArea.appendChild(timeLabel);
                        break;
                        
                    case 'multiplication':
                        const multContainer = document.createElement('div');
                        multContainer.style.display = 'flex';
                        multContainer.style.justifyContent = 'center';
                        multContainer.style.alignItems = 'center';
                        multContainer.style.flexWrap = 'wrap';
                        multContainer.style.gap = '20px';
                        
                        for (let group = 0; group < visual.a; group++) {
                            const groupWrapper = document.createElement('div');
                            groupWrapper.className = 'mult-group';
                            groupWrapper.style.animationDelay = `${group * 0.2}s`;
                            
                            const groupCircle = document.createElement('div');
                            groupCircle.className = 'mult-group-circle';
                            
                            const label = document.createElement('div');
                            label.className = 'mult-label';
                            label.textContent = `Group ${group + 1}`;
                            groupCircle.appendChild(label);
                            
                            for (let i = 0; i < visual.b; i++) {
                                const item = document.createElement('div');
                                item.className = 'visual-item purple';
                                item.style.animationDelay = `${(group * 0.2) + (i * 0.05)}s`;
                                groupCircle.appendChild(item);
                            }
                            
                            groupWrapper.appendChild(groupCircle);
                            multContainer.appendChild(groupWrapper);
                        }
                        
                        visualArea.appendChild(multContainer);
                        break;
                        
                    case 'division':
                        const divContainer = document.createElement('div');
                        divContainer.style.display = 'flex';
                        divContainer.style.justifyContent = 'center';
                        divContainer.style.flexWrap = 'wrap';
                        divContainer.style.gap = '15px';
                        
                        const itemsPerGroup = visual.total / visual.groups;
                        
                        for (let g = 0; g < visual.groups; g++) {
                            const groupDiv = document.createElement('div');
                            groupDiv.style.border = '4px dashed #ff6b6b';
                            groupDiv.style.padding = '15px';
                            groupDiv.style.borderRadius = '15px';
                            groupDiv.style.display = 'flex';
                            groupDiv.style.flexWrap = 'wrap';
                            groupDiv.style.justifyContent = 'center';
                            groupDiv.style.gap = '8px';
                            groupDiv.style.background = 'rgba(255, 107, 107, 0.1)';
                            groupDiv.style.minWidth = '100px';
                            groupDiv.style.animation = `groupPop 0.5s ease ${g * 0.15}s backwards`;
                            
                            for (let i = 0; i < itemsPerGroup; i++) {
                                const item = document.createElement('div');
                                item.className = 'visual-item orange';
                                item.style.width = '35px';
                                item.style.height = '35px';
                                item.style.animationDelay = `${(g * 0.15) + (i * 0.05)}s`;
                                groupDiv.appendChild(item);
                            }
                            divContainer.appendChild(groupDiv);
                        }
                        
                        visualArea.appendChild(divContainer);
                        break;
                        
                    case 'fraction':
                        const fractionDiv = document.createElement('div');
                        fractionDiv.style.display = 'grid';
                        fractionDiv.style.gridTemplateColumns = `repeat(${visual.denominator}, 1fr)`;
                        fractionDiv.style.gap = '8px';
                        fractionDiv.style.width = '260px';
                        fractionDiv.style.margin = '0 auto';
                        
                        for (let i = 0; i < visual.denominator; i++) {
                            const part = document.createElement('div');
                            part.style.width = '60px';
                            part.style.height = '60px';
                            part.style.border = '3px solid #333';
                            part.style.borderRadius = '10px';
                            part.style.transition = 'all 0.3s ease';
                            part.style.animation = `itemPop 0.5s ease ${i * 0.1}s backwards`;
                            
                            if (i < visual.numerator) {
                                part.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                                part.style.boxShadow = '0 5px 15px rgba(78, 205, 196, 0.3)';
                            } else {
                                part.style.backgroundColor = '#f5f5f5';
                            }
                            fractionDiv.appendChild(part);
                        }
                        visualArea.appendChild(fractionDiv);
                        break;
                        
                    case 'measurement':
                        const ruler = document.createElement('div');
                        ruler.style.width = '350px';
                        ruler.style.height = '50px';
                        ruler.style.background = '#fff';
                        ruler.style.border = '3px solid #333';
                        ruler.style.position = 'relative';
                        ruler.style.borderRadius = '5px';
                        ruler.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                        
                        for (let i = 0; i <= visual.length; i++) {
                            const mark = document.createElement('div');
                            mark.style.position = 'absolute';
                            mark.style.left = `${(i / visual.length) * 100}%`;
                            mark.style.top = '0';
                            mark.style.width = '2px';
                            mark.style.height = i % 5 === 0 ? '25px' : '15px';
                            mark.style.background = '#333';
                            ruler.appendChild(mark);
                            
                            if (i % 1 === 0) {
                                const num = document.createElement('div');
                                num.style.position = 'absolute';
                                num.style.left = `${(i / visual.length) * 100}%`;
                                num.style.top = '30px';
                                num.style.transform = 'translateX(-50%)';
                                num.style.fontSize = '12px';
                                num.style.fontWeight = 'bold';
                                num.textContent = i;
                                ruler.appendChild(num);
                            }
                        }
                        
                        const item = document.createElement('div');
                        item.style.position = 'absolute';
                        item.style.top = '-40px';
                        item.style.left = '0';
                        item.style.width = `${(visual.length / 12) * 350}px`;
                        item.style.height = '30px';
                        item.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
                        item.style.borderRadius = '8px';
                        item.style.display = 'flex';
                        item.style.alignItems = 'center';
                        item.style.justifyContent = 'center';
                        item.style.color = 'white';
                        item.style.fontWeight = 'bold';
                        item.style.fontSize = '14px';
                        item.style.boxShadow = '0 5px 15px rgba(255, 107, 107, 0.4)';
                        item.textContent = visual.item;
                        
                        ruler.appendChild(item);
                        visualArea.appendChild(ruler);
                        break;
                }
            }

            displayAnswerOptions() {
                const optionsContainer = document.getElementById('answerOptions');
                optionsContainer.innerHTML = '';
                
                this.currentQuestion.options.forEach((option, idx) => {
                    const button = document.createElement('button');
                    button.className = 'answer-btn';
                    button.style.animationDelay = `${idx * 0.1}s`;
                    button.style.animation = 'itemPop 0.5s ease backwards';
                    button.textContent = option;
                    button.addEventListener('click', () => {
                        this.checkAnswer(option, button);
                    });
                    optionsContainer.appendChild(button);
                });
            }

            checkAnswer(selectedAnswer, buttonElement) {
                const isCorrect = selectedAnswer === this.currentQuestion.correct;
                
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                if (isCorrect) {
                    buttonElement.classList.add('correct');
                    this.score += 10;
                    this.streak++;
                    this.questionsCorrect++;
                    
                    const encouragingPhrases = [
                        "Great job! That's correct!",
                        "Excellent work! You got it right!",
                        "Fantastic! Well done!",
                        "Super! You're doing amazing!",
                        "Perfect! Keep it up!",
                        "Wonderful! You're a math star!",
                        "Outstanding! That's the right answer!",
                        "Brilliant! You're getting good at this!"
                    ];
                    
                    const phrase = encouragingPhrases[Math.floor(Math.random() * encouragingPhrases.length)];
                    this.showFeedback(true, `${phrase} 🌟`);
                    
                    if (this.streak >= 3) {
                        setTimeout(() => {
                            this.speak(`Amazing! You're on a streak of ${this.streak} correct answers!`, { 
                                pitch: 1.2, 
                                showSpeaking: true 
                            });
                        }, 1500);
                    } else {
                        setTimeout(() => {
                            this.speak(phrase, { 
                                pitch: 1.2, 
                                showSpeaking: true 
                            });
                        }, 300);
                    }
                    
                    this.celebrate();
                } else {
                    buttonElement.classList.add('incorrect');
                    this.streak = 0;
                    
                    document.querySelectorAll('.answer-btn').forEach(btn => {
                        if (btn.textContent == this.currentQuestion.correct) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    const encouragingCorrection = [
                        `Not quite! The correct answer is ${this.currentQuestion.correct}. You'll get it next time!`,
                        `Close! The right answer is ${this.currentQuestion.correct}. Keep trying!`,
                        `Almost there! It's ${this.currentQuestion.correct}. You're learning!`,
                        `Good try! The answer is ${this.currentQuestion.correct}. Practice makes perfect!`,
                        `Nice effort! The correct answer is ${this.currentQuestion.correct}. Don't give up!`
                    ];
                    
                    const feedback = encouragingCorrection[Math.floor(Math.random() * encouragingCorrection.length)];
                    this.showFeedback(false, `${feedback} 💪`);
                    
                    setTimeout(() => {
                        this.speak(feedback, { 
                            rate: this.speechRate * 0.9,
                            showSpeaking: true 
                        });
                    }, 300);
                }
                
                this.updateScore();
                document.getElementById('nextBtn').style.display = 'inline-block';
            }

            showFeedback(isCorrect, message) {
                const feedback = document.getElementById('feedback');
                feedback.textContent = message;
                feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.style.display = 'block';
            }

            clearFeedback() {
                document.getElementById('feedback').style.display = 'none';
                
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('correct', 'incorrect');
                });
            }

            showHint() {
                if (this.currentQuestion.hint) {
                    this.showFeedback(false, `💡 Hint: ${this.currentQuestion.hint}`);
                    
                    setTimeout(() => {
                        this.speak(`Here's a hint: ${this.currentQuestion.hint}`, { 
                            rate: this.speechRate * 0.9,
                            showSpeaking: true 
                        });
                    }, 200);
                }
            }

            updateScore() {
                document.getElementById('scoreDisplay').textContent = `Score: ${this.score} | Streak: ${this.streak}`;
            }

            updateProgress() {
                const progress = (this.questionCount / this.totalQuestions) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
            }

            celebrate() {
                const celebration = document.getElementById('celebration');
                
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#ff8e53', '#ab47bc'][Math.floor(Math.random() * 7)];
                    confetti.style.animationDelay = Math.random() * 1 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    celebration.appendChild(confetti);
                    
                    setTimeout(() => {
                        confetti.remove();
                    }, 4000);
                }
            }

            endGame() {
                const percentage = Math.round((this.questionsCorrect / this.totalQuestions) * 100);
                let message = '';
                let voiceMessage = '';
                let emoji = '';
                
                if (percentage >= 90) {
                    message = "Outstanding! You're a math superstar!";
                    voiceMessage = "Outstanding! You got almost all the questions right! You're a real math superstar!";
                    emoji = "🌟⭐🏆";
                } else if (percentage >= 80) {
                    message = "Excellent work! You're doing great!";
                    voiceMessage = "Excellent work! You did really well! Keep up the great learning!";
                    emoji = "🎉👏";
                } else if (percentage >= 70) {
                    message = "Good job! Keep practicing!";
                    voiceMessage = "Good job! You're getting better and better! Keep practicing and you'll be amazing!";
                    emoji = "👍😊";
                } else {
                    message = "Nice try! Practice makes perfect!";
                    voiceMessage = "Nice try! Remember, practice makes perfect! You're learning and that's what matters!";
                    emoji = "💪🌱";
                }
                
                document.getElementById('questionDisplay').innerHTML = `
                    <div style="animation: itemPop 0.6s ease;">
                        <h2 style="margin-bottom: 15px;">Game Complete! ${emoji}</h2>
                        <p style="font-size: 0.7em; margin-bottom: 10px;">${message}</p>
                        <p style="font-size: 0.6em; margin-bottom: 8px;">You got ${this.questionsCorrect} out of ${this.totalQuestions} questions correct!</p>
                        <p style="font-size: 0.65em;">Final Score: ${this.score}</p>
                    </div>
                `;
                
                document.getElementById('visualArea').innerHTML = '';
                document.getElementById('answerOptions').innerHTML = '';
                document.getElementById('nextBtn').style.display = 'none';
                
                const controlsDiv = document.querySelector('.controls');
                const existingRestartBtn = controlsDiv.querySelector('.restart-btn');
                if (existingRestartBtn) {
                    existingRestartBtn.remove();
                }
                
                const restartBtn = document.createElement('button');
                restartBtn.className = 'control-btn restart-btn';
                restartBtn.textContent = '🔄 Play Again';
                restartBtn.addEventListener('click', () => {
                    restartBtn.remove();
                    this.selectTopic(this.currentTopic);
                });
                
                controlsDiv.appendChild(restartBtn);
                
                setTimeout(() => {
                    this.speak(voiceMessage, { 
                        pitch: 1.2, 
                        showSpeaking: true 
                    });
                }, 1000);
                
                if (percentage >= 80) {
                    setTimeout(() => {
                        this.celebrate();
                    }, 500);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new MathQuestApp();
        });
    </script>
</body>
</html>
