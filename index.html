<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathQuest Kids - Learn Math K-3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 800px;
            min-height: 600px;
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            background-size: 300% 300%;
            animation: gradient 6s ease infinite;
            padding: 20px;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
        }

        .grade-selector {
            padding: 20px;
            text-align: center;
            background: #f8f9ff;
        }

        .grade-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .grade-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .grade-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        .topic-selector {
            padding: 20px;
            display: none;
            background: #f0f4ff;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .topic-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            border-color: #ff6b6b;
        }

        .topic-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .game-area {
            padding: 30px;
            display: none;
            text-align: center;
            min-height: 400px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .question-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin: 20px 0;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .visual-area {
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .visual-item {
            width: 40px;
            height: 40px;
            background: #ff6b6b;
            border-radius: 50%;
            display: inline-block;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }

        .visual-item.apple { background: #ff6b6b; }
        .visual-item.orange { background: #ffa726; }
        .visual-item.green { background: #66bb6a; }
        .visual-item.blue { background: #42a5f5; }
        .visual-item.purple { background: #ab47bc; }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .answer-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }

        .answer-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.4);
        }

        .answer-btn:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .answer-btn.correct {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            animation: bounce 0.6s ease;
        }

        .answer-btn.incorrect {
            background: linear-gradient(45deg, #ef5350, #f44336);
            animation: shake 0.5s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            display: none;
        }

        .feedback.correct {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
            color: #2e7d32;
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, #ffcdd2, #ef9a9a);
            color: #c62828;
        }

        .controls {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .voice-controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .voice-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .voice-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            animation: pulse 2s infinite;
        }

        .voice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .speaker-icon {
            display: inline-block;
            animation: soundWave 1s ease-in-out infinite;
        }

        @keyframes soundWave {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .control-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
        }

        .score-display {
            background: linear-gradient(135deg, #ffd54f, #ffb300);
            color: #bf360c;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-block;
            box-shadow: 0 8px 20px rgba(255, 213, 79, 0.3);
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: fall 3s linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .hidden { display: none; }
        .show { display: block; }

        @media (max-width: 600px) {
            .app-container {
                width: 95%;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .question-display {
                font-size: 1.8em;
                padding: 25px;
            }
            
            .answer-btn {
                padding: 15px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>üåü MathQuest Kids üåü</h1>
            <p>Fun Math Adventures for Little Learners!</p>
        </header>

        <!-- Grade Selection -->
        <div id="gradeSelection" class="grade-selector">
            <h2>Choose Your Grade Level:</h2>
            <button class="grade-btn" data-grade="k">üéà Kindergarten</button>
            <button class="grade-btn" data-grade="1">üöÄ Grade 1</button>
            <button class="grade-btn" data-grade="2">‚≠ê Grade 2</button>
            <button class="grade-btn" data-grade="3">üèÜ Grade 3</button>
        </div>

        <!-- Topic Selection -->
        <div id="topicSelection" class="topic-selector">
            <h2>Choose a Math Adventure:</h2>
            <div class="topic-grid" id="topicGrid">
                <!-- Topics will be populated by JavaScript -->
            </div>
        </div>

        <!-- Game Area -->
        <div id="gameArea" class="game-area">
            <div class="score-display" id="scoreDisplay">Score: 0 | Streak: 0</div>
            <div class="voice-controls">
                <button class="voice-btn" id="voiceToggle">üîä Voice On</button>
                <button class="voice-btn" id="repeatQuestion">üîÑ Repeat Question</button>
                <button class="voice-btn" id="voiceSpeed">üêå Normal Speed</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="question-display" id="questionDisplay"></div>
            <div class="visual-area" id="visualArea"></div>
            <div class="answer-options" id="answerOptions"></div>
            <div class="feedback" id="feedback"></div>
            <div class="controls">
                <button class="control-btn" id="nextBtn" style="display: none;">Next Question ‚Üí</button>
                <button class="control-btn" id="backBtn">‚Üê Back to Topics</button>
                <button class="control-btn" id="hintBtn">üí° Hint</button>
            </div>
        </div>
    </div>

    <div class="celebration" id="celebration"></div>

    <script>
        class MathQuestApp {
            constructor() {
                this.currentGrade = null;
                this.currentTopic = null;
                this.currentQuestion = null;
                this.score = 0;
                this.streak = 0;
                this.questionCount = 0;
                this.totalQuestions = 10;
                this.questionsCorrect = 0;
                
                // Voice settings
                this.voiceEnabled = true;
                this.speechSynthesis = window.speechSynthesis;
                this.currentVoice = null;
                this.speechRate = 0.8; // Slower for kids
                this.availableVoices = [];
                
                // Initialize voices
                this.initializeVoices();
                
                this.topics = {
                    k: [
                        { id: 'counting', name: 'Counting 1-10', icon: 'üî¢', description: 'Count objects and numbers' },
                        { id: 'shapes', name: 'Shapes', icon: '‚ö™', description: 'Learn basic shapes' },
                        { id: 'patterns', name: 'Patterns', icon: 'üî¥üîµ', description: 'Simple patterns' },
                        { id: 'size', name: 'Big & Small', icon: 'üìè', description: 'Compare sizes' }
                    ],
                    1: [
                        { id: 'addition10', name: 'Addition to 10', icon: '‚ûï', description: 'Add numbers up to 10' },
                        { id: 'subtraction10', name: 'Subtraction to 10', icon: '‚ûñ', description: 'Subtract numbers up to 10' },
                        { id: 'counting20', name: 'Counting to 20', icon: 'üî¢', description: 'Count higher numbers' },
                        { id: 'place_value', name: 'Tens & Ones', icon: 'üîü', description: 'Understanding place value' }
                    ],
                    2: [
                        { id: 'addition100', name: 'Addition to 100', icon: '‚ûï', description: 'Add bigger numbers' },
                        { id: 'subtraction100', name: 'Subtraction to 100', icon: '‚ûñ', description: 'Subtract bigger numbers' },
                        { id: 'skip_counting', name: 'Skip Counting', icon: '‚è≠Ô∏è', description: 'Count by 2s, 5s, 10s' },
                        { id: 'time', name: 'Time', icon: 'üïê', description: 'Reading clocks' }
                    ],
                    3: [
                        { id: 'multiplication', name: 'Multiplication', icon: '‚úñÔ∏è', description: 'Times tables' },
                        { id: 'division', name: 'Division', icon: '‚ûó', description: 'Sharing equally' },
                        { id: 'fractions', name: 'Fractions', icon: 'üçï', description: 'Parts of a whole' },
                        { id: 'measurement', name: 'Measurement', icon: 'üìê', description: 'Length and weight' }
                    ]
                };
                
                this.initializeApp();
            }

            initializeApp() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Grade selection
                document.querySelectorAll('.grade-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectGrade(e.target.dataset.grade);
                    });
                });

                // Control buttons
                document.getElementById('backBtn').addEventListener('click', () => {
                    this.showTopicSelection();
                });

                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });

                document.getElementById('hintBtn').addEventListener('click', () => {
                    this.showHint();
                });

                // Voice control buttons
                document.getElementById('voiceToggle').addEventListener('click', () => {
                    this.toggleVoice();
                });

                document.getElementById('repeatQuestion').addEventListener('click', () => {
                    this.repeatCurrentQuestion();
                });

                document.getElementById('voiceSpeed').addEventListener('click', () => {
                    this.cycleVoiceSpeed();
                });
            }

            initializeVoices() {
                // Load available voices
                const loadVoices = () => {
                    this.availableVoices = this.speechSynthesis.getVoices();
                    
                    // Prefer child-friendly voices
                    const preferredVoices = [
                        'Google UK English Female',
                        'Microsoft Zira Desktop',
                        'Alex',
                        'Samantha',
                        'Google US English'
                    ];
                    
                    // Find the best voice
                    for (let preferred of preferredVoices) {
                        const voice = this.availableVoices.find(v => 
                            v.name.includes(preferred) || v.name.toLowerCase().includes('female')
                        );
                        if (voice) {
                            this.currentVoice = voice;
                        case 'counting_sequence':
                        const sequenceContainer = document.createElement('div');
                        sequenceContainer.style.display = 'flex';
                        sequenceContainer.style.justifyContent = 'center';
                        sequenceContainer.style.alignItems = 'center';
                        sequenceContainer.style.flexWrap = 'wrap';
                        sequenceContainer.style.gap = '10px';
                        sequenceContainer.style.margin = '20px 0';
                        
                        // Show sequence leading up to the target
                        for (let i = visual.start; i < visual.target; i++) {
                            const numberBox = document.createElement('div');
                            numberBox.textContent = i;
                            numberBox.style.width = '50px';
                            numberBox.style.height = '50px';
                            numberBox.style.display = 'flex';
                            numberBox.style.alignItems = 'center';
                            numberBox.style.justifyContent = 'center';
                            numberBox.style.backgroundColor = '#4ecdc4';
                            numberBox.style.color = 'white';
                            numberBox.style.borderRadius = '10px';
                            numberBox.style.fontSize = '18px';
                            numberBox.style.fontWeight = 'bold';
                            numberBox.style.boxShadow = '0 4px 8px rgba(78, 205, 196, 0.3)';
                            sequenceContainer.appendChild(numberBox);
                        }
                        
                        // Add question mark for next number
                        const questionBox = document.createElement('div');
                        questionBox.textContent = '?';
                        questionBox.style.width = '50px';
                        questionBox.style.height = '50px';
                        questionBox.style.display = 'flex';
                        questionBox.style.alignItems = 'center';
                        questionBox.style.justifyContent = 'center';
                        questionBox.style.backgroundColor = '#ff6b6b';
                        questionBox.style.color = 'white';
                        questionBox.style.borderRadius = '10px';
                        questionBox.style.fontSize = '24px';
                        questionBox.style.fontWeight = 'bold';
                        questionBox.style.boxShadow = '0 4px 8px rgba(255, 107, 107, 0.3)';
                        sequenceContainer.appendChild(questionBox);
                        
                        visualArea.appendChild(sequenceContainer);
                        break;
                        }
                    }
                    
                    // Fallback to first English voice
                    if (!this.currentVoice) {
                        this.currentVoice = this.availableVoices.find(v => 
                            v.lang.startsWith('en')
                        ) || this.availableVoices[0];
                    }
                };

                // Load voices immediately if available
                loadVoices();
                
                // Also load when voices change (some browsers load async)
                this.speechSynthesis.addEventListener('voiceschanged', loadVoices);
            }

            speak(text, options = {}) {
                if (!this.voiceEnabled || !this.speechSynthesis) return;
                
                // Stop any current speech
                this.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Configure utterance
                utterance.voice = this.currentVoice;
                utterance.rate = options.rate || this.speechRate;
                utterance.pitch = options.pitch || 1.1; // Slightly higher for kids
                utterance.volume = options.volume || 0.8;
                
                // Add visual feedback
                if (options.showSpeaking) {
                    this.showSpeakingIndicator();
                    utterance.addEventListener('end', () => {
                        this.hideSpeakingIndicator();
                    });
                }
                
                this.speechSynthesis.speak(utterance);
                return utterance;
            }

            toggleVoice() {
                this.voiceEnabled = !this.voiceEnabled;
                const btn = document.getElementById('voiceToggle');
                
                if (this.voiceEnabled) {
                    btn.textContent = 'üîä Voice On';
                    btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                    this.speak("Voice is now on! I'll read questions and give you feedback.", { showSpeaking: true });
                } else {
                    btn.textContent = 'üîá Voice Off';
                    btn.style.background = 'linear-gradient(45deg, #666, #888)';
                    this.speechSynthesis.cancel();
                }
            }

            repeatCurrentQuestion() {
                if (this.currentQuestion) {
                    this.speak(this.currentQuestion.question, { showSpeaking: true });
                }
            }

            cycleVoiceSpeed() {
                const speeds = [
                    { rate: 0.6, label: 'üêå Slow', description: 'Speaking slowly' },
                    { rate: 0.8, label: 'üö∂ Normal', description: 'Speaking at normal speed' },
                    { rate: 1.0, label: 'üèÉ Fast', description: 'Speaking quickly' }
                ];
                
                const currentIndex = speeds.findIndex(s => s.rate === this.speechRate);
                const nextIndex = (currentIndex + 1) % speeds.length;
                const nextSpeed = speeds[nextIndex];
                
                this.speechRate = nextSpeed.rate;
                
                const btn = document.getElementById('voiceSpeed');
                btn.textContent = nextSpeed.label;
                
                this.speak(nextSpeed.description, { rate: this.speechRate, showSpeaking: true });
            }

            showSpeakingIndicator() {
                const indicator = document.createElement('span');
                indicator.id = 'speakingIndicator';
                indicator.innerHTML = ' <span class="speaker-icon">üîä</span>';
                indicator.style.color = '#4ecdc4';
                indicator.style.fontWeight = 'bold';
                
                const questionDisplay = document.getElementById('questionDisplay');
                questionDisplay.appendChild(indicator);
            }

            hideSpeakingIndicator() {
                const indicator = document.getElementById('speakingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            selectGrade(grade) {
                this.currentGrade = grade;
                
                // Update active grade button
                document.querySelectorAll('.grade-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-grade="${grade}"]`).classList.add('active');
                
                this.showTopicSelection();
            }

            showTopicSelection() {
                document.getElementById('gradeSelection').style.display = 'none';
                document.getElementById('gameArea').style.display = 'none';
                document.getElementById('topicSelection').style.display = 'block';
                
                this.populateTopics();
            }

            populateTopics() {
                const topicGrid = document.getElementById('topicGrid');
                topicGrid.innerHTML = '';
                
                this.topics[this.currentGrade].forEach(topic => {
                    const topicCard = document.createElement('div');
                    topicCard.className = 'topic-card';
                    topicCard.innerHTML = `
                        <div class="topic-icon">${topic.icon}</div>
                        <h3>${topic.name}</h3>
                        <p>${topic.description}</p>
                    `;
                    topicCard.addEventListener('click', () => {
                        this.selectTopic(topic.id);
                    });
                    topicGrid.appendChild(topicCard);
                });
            }

            selectTopic(topicId) {
                this.currentTopic = topicId;
                this.score = 0;
                this.streak = 0;
                this.questionCount = 0;
                this.questionsCorrect = 0;
                
                document.getElementById('topicSelection').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                
                this.startGame();
            }

            startGame() {
                this.updateScore();
                
                // Welcome message with voice
                const welcomeMessages = [
                    `Welcome to ${this.getTopicName()}! Let's practice some math together!`,
                    `Great choice! Time to have fun with ${this.getTopicName()}!`,
                    `Ready to learn ${this.getTopicName()}? Let's go!`,
                    `Let's explore ${this.getTopicName()} together! You've got this!`
                ];
                
                const welcomeMsg = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                
                setTimeout(() => {
                    this.speak(welcomeMsg, { showSpeaking: true });
                }, 800);
                
                this.nextQuestion();
            }

            getTopicName() {
                const topicNames = {
                    counting: 'counting',
                    shapes: 'shapes',
                    patterns: 'patterns',
                    size: 'size comparison',
                    addition10: 'addition',
                    subtraction10: 'subtraction',
                    counting20: 'counting to twenty',
                    place_value: 'place value',
                    addition100: 'addition',
                    subtraction100: 'subtraction',
                    skip_counting: 'skip counting',
                    time: 'telling time',
                    multiplication: 'multiplication',
                    division: 'division',
                    fractions: 'fractions',
                    measurement: 'measurement'
                };
                
                return topicNames[this.currentTopic] || 'math';
            }

            nextQuestion() {
                if (this.questionCount >= this.totalQuestions) {
                    this.endGame();
                    return;
                }

                this.questionCount++;
                this.clearFeedback();
                document.getElementById('nextBtn').style.display = 'none';
                
                this.currentQuestion = this.generateQuestion();
                this.displayQuestion();
                this.updateProgress();
            }

            generateQuestion() {
                const generators = {
                    // Kindergarten
                    counting: () => this.generateCounting(),
                    shapes: () => this.generateShapes(),
                    patterns: () => this.generatePatterns(),
                    size: () => this.generateSize(),
                    
                    // Grade 1
                    addition10: () => this.generateAddition(10),
                    subtraction10: () => this.generateSubtraction(10),
                    counting20: () => this.generateCountingHigher(),
                    place_value: () => this.generatePlaceValue(),
                    
                    // Grade 2
                    addition100: () => this.generateAddition(100),
                    subtraction100: () => this.generateSubtraction(100),
                    skip_counting: () => this.generateSkipCounting(),
                    time: () => this.generateTime(),
                    
                    // Grade 3
                    multiplication: () => this.generateMultiplication(),
                    division: () => this.generateDivision(),
                    fractions: () => this.generateFractions(),
                    measurement: () => this.generateMeasurement()
                };

                return generators[this.currentTopic]();
            }

            generateCounting() {
                const max = Math.floor(Math.random() * 5) + 3; // 3-7 objects
                const colors = ['apple', 'orange', 'green', 'blue', 'purple'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = Math.floor(Math.random() * 10) + 1;
                    if (wrong !== max && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }

                return {
                    question: "How many objects do you see?",
                    visual: { type: 'objects', count: max, color: color },
                    correct: max,
                    options: [max, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Try counting each object: 1, 2, 3...`
                };
            }

            generateShapes() {
                const shapes = [
                    { name: 'circle', symbol: '‚ö™', sides: 'no corners, curved line' },
                    { name: 'square', symbol: '‚¨ú', sides: '4 equal sides and corners' },
                    { name: 'triangle', symbol: 'üî∫', sides: '3 sides and corners' },
                    { name: 'rectangle', symbol: '‚ñ≠', sides: '4 sides and corners, opposite sides equal' }
                ];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                const wrongShapes = shapes.filter(s => s !== shape).slice(0, 3);

                return {
                    question: `Which shape is this?`,
                    visual: { type: 'shape', shape: shape.symbol, name: shape.name },
                    correct: shape.name,
                    options: [shape.name, ...wrongShapes.map(s => s.name)].sort(() => Math.random() - 0.5),
                    hint: `This shape has ${shape.sides}.`
                };
            }

            generatePatterns() {
                const patterns = [
                    { pattern: ['üî¥', 'üîµ'], next: 'üî¥', name: 'red-blue pattern' },
                    { pattern: ['‚≠ê', '‚≠ê', '‚ù§Ô∏è'], next: '‚≠ê', name: 'star-star-heart pattern' },
                    { pattern: ['üü°', 'üü¢', 'üü°'], next: 'üü¢', name: 'yellow-green-yellow pattern' },
                    { pattern: ['üî¥', 'üî¥', 'üîµ'], next: 'üî¥', name: 'red-red-blue pattern' }
                ];
                const selected = patterns[Math.floor(Math.random() * patterns.length)];
                
                // Create wrong answer options from other patterns
                const wrongOptions = patterns
                    .filter(p => p !== selected)
                    .map(p => p.next)
                    .slice(0, 3);
                
                return {
                    question: "What comes next in the pattern?",
                    visual: { 
                        type: 'pattern', 
                        pattern: [...selected.pattern, ...selected.pattern, '‚ùì'],
                        patternName: selected.name
                    },
                    correct: selected.next,
                    options: [selected.next, ...wrongOptions].sort(() => Math.random() - 0.5),
                    hint: `Look for the repeating ${selected.name}!`
                };
            }

            generateSize() {
                const questions = [
                    { question: 'Which circle is bigger?', correct: 'the big circle' },
                    { question: 'Which circle is smaller?', correct: 'the small circle' }
                ];
                const selected = questions[Math.floor(Math.random() * questions.length)];
                
                return {
                    question: selected.question,
                    visual: { type: 'size', questionType: selected.correct },
                    correct: selected.correct,
                    options: ['the big circle', 'the small circle'],
                    hint: "Look carefully at the sizes and compare them!"
                };
            }

            generateAddition(max) {
                const a = Math.floor(Math.random() * (max/2)) + 1;
                const b = Math.floor(Math.random() * (max - a)) + 1;
                const sum = a + b;
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = sum + Math.floor(Math.random() * 6) - 3;
                    if (wrong > 0 && wrong !== sum && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }

                return {
                    question: `${a} + ${b} = ?`,
                    visual: { type: 'addition', a: a, b: b },
                    correct: sum,
                    options: [sum, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Count all the objects together!`
                };
            }

            generateSubtraction(max) {
                const start = Math.floor(Math.random() * max/2) + 3;
                const subtract = Math.floor(Math.random() * (start - 1)) + 1;
                const result = start - subtract;
                
                const wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    const wrong = result + Math.floor(Math.random() * 6) - 3;
                    if (wrong >= 0 && wrong !== result && !wrongAnswers.includes(wrong)) {
                        wrongAnswers.push(wrong);
                    }
                }

                return {
                    question: `${start} - ${subtract} = ?`,
                    visual: { type: 'subtraction', start: start, subtract: subtract },
                    correct: result,
                    options: [result, ...wrongAnswers].sort(() => Math.random() - 0.5),
                    hint: `Take away ${subtract} objects from ${start}.`
                };
            }

            generateCountingHigher() {
                const start = Math.floor(Math.random() * 5) + 11; // 11-15
                const target = start + Math.floor(Math.random() * 3) + 2; // +2 to +4
                
                // Generate wrong answers
                const wrongAnswers = [];
                [target + 1, target - 1, target + 2].forEach(wrong => {
                    if (wrong > 0 && wrong <= 20 && wrong !== target) {
                        wrongAnswers.push(wrong);
                    }
                });
                
                return {
                    question: `What number comes after ${target - 1}?`,
                    visual: { type: 'counting_sequence', start: start, target: target },
                    correct: target,
                    options: [target, ...wrongAnswers.slice(0, 3)].sort(() => Math.random() - 0.5),
                    hint: `Count up from ${start}: ${start}, ${start + 1}, ${start + 2}...`
                };
            }

            generatePlaceValue() {
                const tens = Math.floor(Math.random() * 3) + 1;
                const ones = Math.floor(Math.random() * 9) + 1;
                const number = tens * 10 + ones;
                
                return {
                    question: `How many ones are in ${number}?`,
                    visual: { type: 'place_value', number: number },
                    correct: ones,
                    options: [ones, tens, number, ones + tens].sort(() => Math.random() - 0.5),
                    hint: `Look at the ones place (the right digit).`
                };
            }

            generateSkipCounting() {
                const skip = [2, 5, 10][Math.floor(Math.random() * 3)];
                const start = skip * 2;
                const sequence = [start, start + skip, start + skip * 2];
                
                return {
                    question: `Skip counting by ${skip}s: ${sequence.join(', ')}, ?`,
                    visual: null,
                    correct: start + skip * 3,
                    options: [start + skip * 3, start + skip * 3 + 1, start + skip * 3 - 1, start + skip * 4],
                    hint: `Add ${skip} to the last number.`
                };
            }

            generateTime() {
                const hour = Math.floor(Math.random() * 12) + 1;
                const minute = [0, 30][Math.floor(Math.random() * 2)];
                const timeStr = minute === 0 ? `${hour}:00` : `${hour}:30`;
                const displayTime = minute === 0 ? `${hour} o'clock` : `${hour}:30`;
                
                // Generate wrong answers
                const wrongTimes = [];
                while (wrongTimes.length < 3) {
                    const wrongHour = Math.floor(Math.random() * 12) + 1;
                    const wrongMinute = [0, 30][Math.floor(Math.random() * 2)];
                    const wrongTimeStr = wrongMinute === 0 ? `${wrongHour}:00` : `${wrongHour}:30`;
                    const wrongDisplayTime = wrongMinute === 0 ? `${wrongHour} o'clock` : `${wrongHour}:30`;
                    
                    if (wrongDisplayTime !== displayTime && !wrongTimes.includes(wrongDisplayTime)) {
                        wrongTimes.push(wrongDisplayTime);
                    }
                }
                
                return {
                    question: `What time does this clock show?`,
                    visual: { type: 'clock', hour: hour, minute: minute },
                    correct: displayTime,
                    options: [displayTime, ...wrongTimes].sort(() => Math.random() - 0.5),
                    hint: `Look carefully at where the hour hand and minute hand are pointing.`
                };
            }

            generateMultiplication() {
                const a = Math.floor(Math.random() * 5) + 2;
                const b = Math.floor(Math.random() * 5) + 2;
                const product = a * b;
                
                return {
                    question: `${a} √ó ${b} = ?`,
                    visual: { type: 'multiplication', a: a, b: b },
                    correct: product,
                    options: [product, product + 1, product - 1, product + a].sort(() => Math.random() - 0.5),
                    hint: `Think of it as ${a} groups of ${b}.`
                };
            }

            generateDivision() {
                const divisor = Math.floor(Math.random() * 4) + 2;
                const quotient = Math.floor(Math.random() * 5) + 2;
                const dividend = divisor * quotient;
                
                return {
                    question: `${dividend} √∑ ${divisor} = ?`,
                    visual: { type: 'division', total: dividend, groups: divisor },
                    correct: quotient,
                    options: [quotient, quotient + 1, quotient - 1, divisor].sort(() => Math.random() - 0.5),
                    hint: `How many groups of ${divisor} make ${dividend}?`
                };
            }

            generateFractions() {
                const denominators = [2, 3, 4];
                const denominator = denominators[Math.floor(Math.random() * denominators.length)];
                const numerator = Math.floor(Math.random() * denominator) + 1;
                
                return {
                    question: `What fraction is shaded?`,
                    visual: { type: 'fraction', numerator: numerator, denominator: denominator },
                    correct: `${numerator}/${denominator}`,
                    options: [`${numerator}/${denominator}`, `${denominator}/${numerator}`, `${numerator + 1}/${denominator}`, `${numerator}/${denominator + 1}`],
                    hint: `Count the shaded parts out of total parts.`
                };
            }

            generateMeasurement() {
                const units = [
                    { item: 'pencil', length: 6, unit: 'inches' },
                    { item: 'book', length: 9, unit: 'inches' },
                    { item: 'table', length: 3, unit: 'feet' }
                ];
                const selected = units[Math.floor(Math.random() * units.length)];
                
                return {
                    question: `How long is the ${selected.item}?`,
                    visual: { type: 'measurement', item: selected.item, length: selected.length },
                    correct: `${selected.length} ${selected.unit}`,
                    options: [`${selected.length} ${selected.unit}`, `${selected.length + 1} ${selected.unit}`, `${selected.length - 1} ${selected.unit}`, `${selected.length} cm`],
                    hint: `Use the ruler to measure carefully.`
                };
            }

            displayQuestion() {
                document.getElementById('questionDisplay').textContent = this.currentQuestion.question;
                this.displayVisual();
                this.displayAnswerOptions();
                
                // Read the question aloud
                setTimeout(() => {
                    this.speak(this.currentQuestion.question, { showSpeaking: true });
                }, 500);
            }

            displayVisual() {
                const visualArea = document.getElementById('visualArea');
                visualArea.innerHTML = '';
                
                if (!this.currentQuestion.visual) return;
                
                const visual = this.currentQuestion.visual;
                
                switch (visual.type) {
                    case 'objects':
                        for (let i = 0; i < visual.count; i++) {
                            const item = document.createElement('div');
                            item.className = `visual-item ${visual.color}`;
                            visualArea.appendChild(item);
                        }
                        break;
                        
                    case 'shape':
                        const shapeContainer = document.createElement('div');
                        shapeContainer.style.textAlign = 'center';
                        shapeContainer.style.margin = '20px 0';
                        
                        const shapeDiv = document.createElement('div');
                        shapeDiv.style.fontSize = '8em';
                        shapeDiv.style.margin = '20px';
                        shapeDiv.style.textShadow = '0 4px 8px rgba(0,0,0,0.2)';
                        shapeDiv.textContent = visual.shape;
                        
                        const shapeLabel = document.createElement('div');
                        shapeLabel.style.fontSize = '18px';
                        shapeLabel.style.fontWeight = 'bold';
                        shapeLabel.style.color = '#666';
                        shapeLabel.style.marginTop = '10px';
                        shapeLabel.textContent = 'What shape is this?';
                        
                        shapeContainer.appendChild(shapeDiv);
                        shapeContainer.appendChild(shapeLabel);
                        visualArea.appendChild(shapeContainer);
                        break;
                        
                    case 'pattern':
                        const patternContainer = document.createElement('div');
                        patternContainer.style.textAlign = 'center';
                        patternContainer.style.margin = '20px 0';
                        
                        const patternRow = document.createElement('div');
                        patternRow.style.display = 'flex';
                        patternRow.style.justifyContent = 'center';
                        patternRow.style.alignItems = 'center';
                        patternRow.style.flexWrap = 'wrap';
                        patternRow.style.gap = '15px';
                        patternRow.style.margin = '20px 0';
                        
                        visual.pattern.forEach((item, index) => {
                            const patternItem = document.createElement('div');
                            patternItem.style.fontSize = '3em';
                            patternItem.style.padding = '10px';
                            patternItem.style.borderRadius = '10px';
                            patternItem.style.minWidth = '60px';
                            patternItem.style.textAlign = 'center';
                            
                            if (item === '‚ùì') {
                                patternItem.style.backgroundColor = '#f0f0f0';
                                patternItem.style.border = '3px dashed #999';
                                patternItem.style.color = '#666';
                            } else {
                                patternItem.style.backgroundColor = 'rgba(255,255,255,0.8)';
                                patternItem.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                            }
                            
                            patternItem.textContent = item;
                            patternRow.appendChild(patternItem);
                        });
                        
                        const patternLabel = document.createElement('div');
                        patternLabel.style.fontSize = '16px';
                        patternLabel.style.fontWeight = 'bold';
                        patternLabel.style.color = '#666';
                        patternLabel.style.marginTop = '15px';
                        patternLabel.textContent = 'What shape comes next?';
                        
                        patternContainer.appendChild(patternRow);
                        patternContainer.appendChild(patternLabel);
                        visualArea.appendChild(patternContainer);
                        break;
                        
                    case 'size':
                        const sizeContainer = document.createElement('div');
                        sizeContainer.style.display = 'flex';
                        sizeContainer.style.justifyContent = 'center';
                        sizeContainer.style.alignItems = 'center';
                        sizeContainer.style.gap = '40px';
                        sizeContainer.style.margin = '30px 0';
                        
                        const bigCircle = document.createElement('div');
                        bigCircle.style.width = '120px';
                        bigCircle.style.height = '120px';
                        bigCircle.style.borderRadius = '50%';
                        bigCircle.style.backgroundColor = '#4ecdc4';
                        bigCircle.style.boxShadow = '0 8px 20px rgba(78, 205, 196, 0.3)';
                        bigCircle.style.position = 'relative';
                        
                        const bigLabel = document.createElement('div');
                        bigLabel.textContent = 'Big';
                        bigLabel.style.position = 'absolute';
                        bigLabel.style.bottom = '-30px';
                        bigLabel.style.left = '50%';
                        bigLabel.style.transform = 'translateX(-50%)';
                        bigLabel.style.fontWeight = 'bold';
                        bigLabel.style.color = '#333';
                        bigCircle.appendChild(bigLabel);
                        
                        const smallCircle = document.createElement('div');
                        smallCircle.style.width = '60px';
                        smallCircle.style.height = '60px';
                        smallCircle.style.borderRadius = '50%';
                        smallCircle.style.backgroundColor = '#ff6b6b';
                        smallCircle.style.boxShadow = '0 6px 15px rgba(255, 107, 107, 0.3)';
                        smallCircle.style.position = 'relative';
                        
                        const smallLabel = document.createElement('div');
                        smallLabel.textContent = 'Small';
                        smallLabel.style.position = 'absolute';
                        smallLabel.style.bottom = '-30px';
                        smallLabel.style.left = '50%';
                        smallLabel.style.transform = 'translateX(-50%)';
                        smallLabel.style.fontWeight = 'bold';
                        smallLabel.style.color = '#333';
                        smallCircle.appendChild(smallLabel);
                        
                        sizeContainer.appendChild(bigCircle);
                        sizeContainer.appendChild(smallCircle);
                        visualArea.appendChild(sizeContainer);
                        break;
                        
                    case 'addition':
                        // Show visual addition with objects
                        for (let i = 0; i < visual.a; i++) {
                            const item = document.createElement('div');
                            item.className = 'visual-item blue';
                            visualArea.appendChild(item);
                        }
                        
                        const plusSign = document.createElement('span');
                        plusSign.style.fontSize = '2em';
                        plusSign.style.margin = '0 20px';
                        plusSign.textContent = '+';
                        visualArea.appendChild(plusSign);
                        
                        for (let i = 0; i < visual.b; i++) {
                            const item = document.createElement('div');
                            item.className = 'visual-item green';
                            visualArea.appendChild(item);
                        }
                        break;
                        
                    case 'subtraction':
                        for (let i = 0; i < visual.start; i++) {
                            const item = document.createElement('div');
                            item.className = 'visual-item apple';
                            if (i >= visual.start - visual.subtract) {
                                item.style.opacity = '0.3';
                                item.style.textDecoration = 'line-through';
                            }
                            visualArea.appendChild(item);
                        }
                        break;
                        
                    case 'place_value':
                        const tensDiv = document.createElement('div');
                        tensDiv.innerHTML = `<h3>Tens: ${Math.floor(visual.number / 10)}</h3>`;
                        const onesDiv = document.createElement('div');
                        onesDiv.innerHTML = `<h3>Ones: ${visual.number % 10}</h3>`;
                        visualArea.appendChild(tensDiv);
                        visualArea.appendChild(onesDiv);
                        break;
                        
                    case 'clock':
                        const clockContainer = document.createElement('div');
                        clockContainer.style.display = 'flex';
                        clockContainer.style.flexDirection = 'column';
                        clockContainer.style.alignItems = 'center';
                        clockContainer.style.margin = '20px 0';
                        
                        const clockFace = document.createElement('div');
                        clockFace.style.width = '200px';
                        clockFace.style.height = '200px';
                        clockFace.style.borderRadius = '50%';
                        clockFace.style.border = '8px solid #333';
                        clockFace.style.background = 'white';
                        clockFace.style.position = 'relative';
                        clockFace.style.margin = '20px';
                        clockFace.style.boxShadow = '0 8px 20px rgba(0,0,0,0.2)';
                        
                        // Clock numbers
                        const numbers = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                        numbers.forEach((num, index) => {
                            const numberDiv = document.createElement('div');
                            numberDiv.textContent = num;
                            numberDiv.style.position = 'absolute';
                            numberDiv.style.fontSize = '16px';
                            numberDiv.style.fontWeight = 'bold';
                            numberDiv.style.color = '#333';
                            
                            const angle = (index * 30) - 90; // Start from 12 o'clock
                            const radian = (angle * Math.PI) / 180;
                            const radius = 75;
                            const x = 92 + radius * Math.cos(radian); // 92 = (200-16)/2
                            const y = 92 + radius * Math.sin(radian);
                            
                            numberDiv.style.left = `${x}px`;
                            numberDiv.style.top = `${y}px`;
                            numberDiv.style.transform = 'translate(-50%, -50%)';
                            
                            clockFace.appendChild(numberDiv);
                        });
                        
                        // Hour hand
                        const hourHand = document.createElement('div');
                        hourHand.style.position = 'absolute';
                        hourHand.style.width = '6px';
                        hourHand.style.height = '50px';
                        hourHand.style.background = '#333';
                        hourHand.style.left = '50%';
                        hourHand.style.top = '50%';
                        hourHand.style.transformOrigin = '50% 100%';
                        hourHand.style.borderRadius = '3px';
                        
                        // Calculate hour hand angle (30 degrees per hour + minute offset)
                        const hourAngle = ((visual.hour % 12) * 30) + (visual.minute * 0.5) - 90;
                        hourHand.style.transform = `translate(-50%, -100%) rotate(${hourAngle}deg)`;
                        
                        // Minute hand
                        const minuteHand = document.createElement('div');
                        minuteHand.style.position = 'absolute';
                        minuteHand.style.width = '4px';
                        minuteHand.style.height = '70px';
                        minuteHand.style.background = '#ff6b6b';
                        minuteHand.style.left = '50%';
                        minuteHand.style.top = '50%';
                        minuteHand.style.transformOrigin = '50% 100%';
                        minuteHand.style.borderRadius = '2px';
                        
                        // Calculate minute hand angle (6 degrees per minute)
                        const minuteAngle = (visual.minute * 6) - 90;
                        minuteHand.style.transform = `translate(-50%, -100%) rotate(${minuteAngle}deg)`;
                        
                        // Center dot
                        const centerDot = document.createElement('div');
                        centerDot.style.position = 'absolute';
                        centerDot.style.width = '12px';
                        centerDot.style.height = '12px';
                        centerDot.style.background = '#333';
                        centerDot.style.borderRadius = '50%';
                        centerDot.style.left = '50%';
                        centerDot.style.top = '50%';
                        centerDot.style.transform = 'translate(-50%, -50%)';
                        
                        clockFace.appendChild(hourHand);
                        clockFace.appendChild(minuteHand);
                        clockFace.appendChild(centerDot);
                        
                        const timeLabel = document.createElement('div');
                        timeLabel.textContent = visual.minute === 0 ? 'What time is it?' : 'What time is it?';
                        timeLabel.style.fontSize = '18px';
                        timeLabel.style.fontWeight = 'bold';
                        timeLabel.style.color = '#666';
                        
                        clockContainer.appendChild(clockFace);
                        clockContainer.appendChild(timeLabel);
                        visualArea.appendChild(clockContainer);
                        break;
                        
                    case 'multiplication':
                        for (let row = 0; row < visual.a; row++) {
                            const rowDiv = document.createElement('div');
                            rowDiv.style.display = 'flex';
                            rowDiv.style.justifyContent = 'center';
                            rowDiv.style.margin = '5px 0';
                            for (let col = 0; col < visual.b; col++) {
                                const item = document.createElement('div');
                                item.className = 'visual-item purple';
                                item.style.margin = '2px';
                                rowDiv.appendChild(item);
                            }
                            visualArea.appendChild(rowDiv);
                        }
                        break;
                        
                    case 'division':
                        const groupSize = visual.total / visual.groups;
                        for (let g = 0; g < visual.groups; g++) {
                            const groupDiv = document.createElement('div');
                            groupDiv.style.border = '2px dashed #666';
                            groupDiv.style.padding = '10px';
                            groupDiv.style.margin = '5px';
                            groupDiv.style.display = 'inline-block';
                            groupDiv.style.borderRadius = '10px';
                            
                            for (let i = 0; i < groupSize; i++) {
                                const item = document.createElement('div');
                                item.className = 'visual-item orange';
                                item.style.margin = '2px';
                                groupDiv.appendChild(item);
                            }
                            visualArea.appendChild(groupDiv);
                        }
                        break;
                        
                    case 'fraction':
                        const fractionDiv = document.createElement('div');
                        fractionDiv.style.display = 'grid';
                        fractionDiv.style.gridTemplateColumns = `repeat(${visual.denominator}, 1fr)`;
                        fractionDiv.style.gap = '5px';
                        fractionDiv.style.width = '200px';
                        fractionDiv.style.margin = '0 auto';
                        
                        for (let i = 0; i < visual.denominator; i++) {
                            const part = document.createElement('div');
                            part.style.width = '40px';
                            part.style.height = '40px';
                            part.style.border = '2px solid #333';
                            part.style.borderRadius = '5px';
                            if (i < visual.numerator) {
                                part.style.backgroundColor = '#4ecdc4';
                            } else {
                                part.style.backgroundColor = '#f0f0f0';
                            }
                            fractionDiv.appendChild(part);
                        }
                        visualArea.appendChild(fractionDiv);
                        break;
                        
                    case 'measurement':
                        const ruler = document.createElement('div');
                        ruler.style.width = '300px';
                        ruler.style.height = '40px';
                        ruler.style.background = 'linear-gradient(to right, #fff 0px, #fff 10px, #000 10px, #000 11px, #fff 11px)';
                        ruler.style.backgroundSize = '20px 100%';
                        ruler.style.border = '2px solid #333';
                        ruler.style.position = 'relative';
                        
                        const item = document.createElement('div');
                        item.textContent = visual.item;
                        item.style.position = 'absolute';
                        item.style.top = '-30px';
                        item.style.left = '0';
                        item.style.width = `${visual.length * 20}px`;
                        item.style.height = '20px';
                        item.style.backgroundColor = '#ff6b6b';
                        item.style.textAlign = 'center';
                        item.style.borderRadius = '5px';
                        item.style.color = 'white';
                        item.style.fontSize = '12px';
                        item.style.lineHeight = '20px';
                        
                        ruler.appendChild(item);
                        visualArea.appendChild(ruler);
                        break;
                }
            }

            displayAnswerOptions() {
                const optionsContainer = document.getElementById('answerOptions');
                optionsContainer.innerHTML = '';
                
                this.currentQuestion.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'answer-btn';
                    button.textContent = option;
                    button.type = 'button'; // Ensure it's a proper button
                    button.setAttribute('data-option', option);
                    button.setAttribute('data-index', index);
                    
                    // Add click event listener
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        this.checkAnswer(option, button);
                    });
                    
                    // Also add touch event for mobile
                    button.addEventListener('touchend', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        this.checkAnswer(option, button);
                    });
                    
                    optionsContainer.appendChild(button);
                });
            }

            checkAnswer(selectedAnswer, buttonElement) {
                console.log('Answer clicked:', selectedAnswer); // Debug log
                
                const isCorrect = selectedAnswer === this.currentQuestion.correct;
                
                // Disable all buttons immediately to prevent double clicks
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                });
                
                if (isCorrect) {
                    buttonElement.classList.add('correct');
                    this.score += 10;
                    this.streak++;
                    this.questionsCorrect++;
                    
                    // Encouraging voice feedback
                    const encouragingPhrases = [
                        "Great job! That's correct!",
                        "Excellent work! You got it right!",
                        "Fantastic! Well done!",
                        "Super! You're doing amazing!",
                        "Perfect! Keep it up!",
                        "Wonderful! You're a math star!",
                        "Outstanding! That's the right answer!",
                        "Brilliant! You're getting good at this!"
                    ];
                    
                    const phrase = encouragingPhrases[Math.floor(Math.random() * encouragingPhrases.length)];
                    this.showFeedback(true, `${phrase} üåü`);
                    
                    // Add special streak feedback
                    if (this.streak >= 3) {
                        setTimeout(() => {
                            this.speak(`Amazing! You're on a streak of ${this.streak} correct answers!`, { 
                                pitch: 1.2, 
                                showSpeaking: true 
                            });
                        }, 1500);
                    } else {
                        setTimeout(() => {
                            this.speak(phrase, { 
                                pitch: 1.2, 
                                showSpeaking: true 
                            });
                        }, 300);
                    }
                    
                    this.celebrate();
                } else {
                    buttonElement.classList.add('incorrect');
                    this.streak = 0;
                    
                    // Highlight correct answer
                    document.querySelectorAll('.answer-btn').forEach(btn => {
                        if (btn.textContent === this.currentQuestion.correct) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    // Gentle, encouraging feedback for wrong answers
                    const encouragingCorrection = [
                        `Not quite! The correct answer is ${this.currentQuestion.correct}. You'll get it next time!`,
                        `Close! The right answer is ${this.currentQuestion.correct}. Keep trying!`,
                        `Almost there! It's ${this.currentQuestion.correct}. You're learning!`,
                        `Good try! The answer is ${this.currentQuestion.correct}. Practice makes perfect!`,
                        `Nice effort! The correct answer is ${this.currentQuestion.correct}. Don't give up!`
                    ];
                    
                    const feedback = encouragingCorrection[Math.floor(Math.random() * encouragingCorrection.length)];
                    this.showFeedback(false, `${feedback} üí™`);
                    
                    setTimeout(() => {
                        this.speak(feedback, { 
                            rate: this.speechRate * 0.9, // Slightly slower for corrections
                            showSpeaking: true 
                        });
                    }, 300);
                }
                
                this.updateScore();
                document.getElementById('nextBtn').style.display = 'inline-block';
            }

            showFeedback(isCorrect, message) {
                const feedback = document.getElementById('feedback');
                feedback.textContent = message;
                feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.style.display = 'block';
            }

            clearFeedback() {
                document.getElementById('feedback').style.display = 'none';
                
                // Re-enable buttons and clear classes
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.pointerEvents = 'auto';
                    btn.classList.remove('correct', 'incorrect');
                });
                
                // Remove any existing restart button from previous game
                const existingRestartBtn = document.querySelector('.controls .control-btn:last-child');
                if (existingRestartBtn && existingRestartBtn.textContent.includes('Play Again')) {
                    existingRestartBtn.remove();
                }
            }

            showHint() {
                if (this.currentQuestion.hint) {
                    this.showFeedback(false, `üí° Hint: ${this.currentQuestion.hint}`);
                    
                    // Read hint aloud
                    setTimeout(() => {
                        this.speak(`Here's a hint: ${this.currentQuestion.hint}`, { 
                            rate: this.speechRate * 0.9,
                            showSpeaking: true 
                        });
                    }, 200);
                }
            }

            updateScore() {
                document.getElementById('scoreDisplay').textContent = `Score: ${this.score} | Streak: ${this.streak}`;
            }

            updateProgress() {
                const progress = (this.questionCount / this.totalQuestions) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
            }

            celebrate() {
                const celebration = document.getElementById('celebration');
                
                // Create confetti
                for (let i = 0; i < 20; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'][Math.floor(Math.random() * 5)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    celebration.appendChild(confetti);
                    
                    // Remove confetti after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 3000);
                }
            }

            endGame() {
                const percentage = Math.round((this.questionsCorrect / this.totalQuestions) * 100);
                let message = '';
                let voiceMessage = '';
                let emoji = '';
                
                if (percentage >= 90) {
                    message = "Outstanding! You're a math superstar!";
                    voiceMessage = "Outstanding! You got almost all the questions right! You're a real math superstar!";
                    emoji = "üåü‚≠êüèÜ";
                } else if (percentage >= 80) {
                    message = "Excellent work! You're doing great!";
                    voiceMessage = "Excellent work! You did really well! Keep up the great learning!";
                    emoji = "üéâüëè";
                } else if (percentage >= 70) {
                    message = "Good job! Keep practicing!";
                    voiceMessage = "Good job! You're getting better and better! Keep practicing and you'll be amazing!";
                    emoji = "üëçüòä";
                } else {
                    message = "Nice try! Practice makes perfect!";
                    voiceMessage = "Nice try! Remember, practice makes perfect! You're learning and that's what matters!";
                    emoji = "üí™üå±";
                }
                
                document.getElementById('questionDisplay').innerHTML = `
                    <h2>Game Complete! ${emoji}</h2>
                    <p>${message}</p>
                    <p>You got ${this.questionsCorrect} out of ${this.totalQuestions} questions correct!</p>
                    <p>Final Score: ${this.score}</p>
                `;
                
                document.getElementById('visualArea').innerHTML = '';
                document.getElementById('answerOptions').innerHTML = '';
                document.getElementById('nextBtn').style.display = 'none';
                
                // Add restart button
                const restartBtn = document.createElement('button');
                restartBtn.className = 'control-btn';
                restartBtn.textContent = 'üîÑ Play Again';
                restartBtn.addEventListener('click', () => {
                    this.selectTopic(this.currentTopic);
                });
                
                document.querySelector('.controls').appendChild(restartBtn);
                
                // Celebratory voice message
                setTimeout(() => {
                    this.speak(voiceMessage, { 
                        pitch: 1.2, 
                        showSpeaking: true 
                    });
                }, 1000);
                
                if (percentage >= 80) {
                    this.celebrate();
                }
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MathQuestApp();
        });
    </script>
</body>
</html>
